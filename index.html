<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title></title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 1280,
    height: 720,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 200 },
            debug: true
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var player;
var platforms;
var health;
var jetpackFuel = 500;
var gameOver;
var isFacingLeft = false;

var game = new Phaser.Game(config);

function preload()
{
    this.load.image('background', 'assets/background.png');
    this.load.image('planets', 'assets/planets.png');
    this.load.image('platform1', 'assets/platform1.png');
    this.load.image('platform2', 'assets/platform2.png');
    this.load.spritesheet('player', 'assets/player.png', { frameWidth: 66, frameHeight: 93 });
}

function create()
{
    this.add.image(640, 360, 'background').setScrollFactor(0.1);
    this.add.image(640, 360, 'planets').setScrollFactor(0.2);

    platforms = this.physics.add.staticGroup();
    platforms.create(640, 460, 'platform2')
    
    player = this.physics.add.sprite(640, 360, 'player');
    player.setMaxVelocityX(300);

    this.cameras.main.startFollow(player);

    this.anims.create({
        key: 'idleLeft',
        frames: this.anims.generateFrameNumbers('player', {start: 8, end: 9}),
        frameRate: 1.3,
        repeat: -1
    })
    this.anims.create({
        key: 'idleRight',
        frames: this.anims.generateFrameNumbers('player', {start: 10, end: 11}),
        frameRate: 1.3,
        repeat: -1
    })
    this.anims.create({
        key: 'walkLeft',
        frames: this.anims.generateFrameNumbers('player', {start: 5, end: 7}),
        frameRate: 5,
        repeat: -1
    })
    this.anims.create({
        key: 'walkRight',
        frames: this.anims.generateFrameNumbers('player', {start: 12, end: 14}),
        frameRate: 5,
        repeat: -1
    })
    this.anims.create({
        key: 'jumpLeft',
        frames: this.anims.generateFrameNumbers('player', {start: 2, end: 4}),
        frameRate: 7,
        repeat: -1
    })
    this.anims.create({
        key: 'jumpRight',
        frames: this.anims.generateFrameNumbers('player', {start: 15, end: 17}),
        frameRate: 7,
        repeat: -1
    })
    this.anims.create({
        key: 'inAirLeft',
        frames: [{key: 'player', frame : 1}],
        frameRate: 1
    })
    this.anims.create({
        key: 'inAirRight',
        frames: [{key: 'player', frame : 18}],
        frameRate: 1
    })
    this.anims.create({
        key: 'stopLeft',
        frames: [{key: 'player', frame : 0}],
        frameRate: 1
    })
    this.anims.create({
        key: 'stopRight',
        frames: [{key: 'player', frame : 19}],
        frameRate: 1
    })

    this.physics.add.collider(player, platforms);
    
    cursors = this.input.keyboard.createCursorKeys();
}

function update()
{
    if (gameOver) {return;}

    //Déplacemets horizontaux
    if (cursors.left.isDown && player.body.touching.down)
    {
        player.setAccelerationX(-200);
        player.anims.play('walkLeft', true);
        isFacingLeft = true;
    }
    else if (cursors.right.isDown && player.body.touching.down)
    {
        player.setAccelerationX(200);
        player.anims.play('walkRight', true);
        isFacingLeft = false;
    }
    else if (cursors.left.isDown && !player.body.touching.down)
    {
        player.setAccelerationX(-100);
        if (!(cursors.up.isDown && jetpackFuel > 0)) {player.anims.play('inAirLeft', true);}
        isFacingLeft = true;
    }
    else if (cursors.right.isDown && !player.body.touching.down)
    {
        player.setAccelerationX(100);
        if (!(cursors.up.isDown && jetpackFuel > 0)) {player.anims.play('inAirRight', true);}
        isFacingLeft = false;
    }
    else if (player.body.velocity.x == 0 && player.body.touching.down)
    {
        if (isFacingLeft) {player.anims.play('idleLeft', true);}
        else {player.anims.play('idleRight', true);}
    }
    else
    {
        player.setAccelerationX(0);
        if (player.body.velocity.x != 0 && player.body.touching.down)
        {
            if (isFacingLeft) {player.anims.play('stopLeft');}
            else {player.anims.play('stopRight');}
        }
        else if (!(cursors.up.isDown && jetpackFuel > 0))
        {
            if (isFacingLeft) {player.anims.play('inAirLeft', true);}
            else {player.anims.play('inAirRight', true);}
        }
    }

    //Déplacemets verticaux
    if (cursors.up.isDown && jetpackFuel > 0)
    {
        player.setAccelerationY(-1000);
        //jetpackFuel -= 10;
        if (isFacingLeft) {player.anims.play('jumpLeft', true);}
        else {player.anims.play('jumpRight', true);}
    }
    else if (jetpackFuel < 50 && player.body.touching.down)
    {
        jetpackFuel += 1;
        player.setAccelerationY(0);
    } else {player.setAccelerationY(0);}

    //Applique du drag quand le perso est au sol uniquement
    if (player.body.touching.down) {player.setDragX(50);}
    else {player.setDragX(0);}

    //Machins de test
    console.log(player.body.velocity.x);
}

</script>
</body>
</html>